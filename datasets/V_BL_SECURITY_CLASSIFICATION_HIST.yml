unique_name: V_BL_SECURITY_CLASSIFICATION_HIST
object_type: dataset
label: V_BL_SECURITY_CLASSIFICATION_HIST
columns:
  - name: SECURITY_ID
    data_type: string
  - name: ALADDIN_SECURITY_CUSIP
    data_type: string
  - name: CLASSIFICATION_SCHEME_CODE
    data_type: string
  - name: CLASSIFICATION_DATE
    data_type: date
  - name: LEVEL_01_NAME
    data_type: string
  - name: TARGET_ENUMERATION_VALUE
    data_type: string
  - name: POSITION_DATE
    data_type: date
connection_id: con_SE_DEMO_LIBRARY_RLAM_POV
sql: |-
  WITH POS AS (
      SELECT
          SECURITY_ID,
          ALADDIN_SECURITY_CUSIP,
          POSITION_DATE
      FROM SE_DEMO_LIBRARY.RLAM_POV.SECURITY_POSITION 
      GROUP BY
          SECURITY_ID,
          ALADDIN_SECURITY_CUSIP,
          POSITION_DATE
  ),

  SecRating AS (
      SELECT
          ALADDIN_SECURITY_CUSIP,
          CLASSIFICATION_SCHEME_CODE,
          CLASSIFICATION_DATE,
          LEVEL_01_NAME,
          TARGET_ENUMERATION_VALUE
      FROM SE_DEMO_LIBRARY.RLAM_POV.V_BL_SECURITY_CLASSIFICATION_HIST
      LEFT JOIN SE_DEMO_LIBRARY.RLAM_POV.V_REF_ENUMERATION_MAPPING RatingFactor
          ON LEVEL_01_NAME = RatingFactor.SOURCE_ENUMERATION_VALUE
      WHERE RatingFactor.ACTIVE_FLAG = TRUE
          AND CLASSIFICATION_SCHEME_CODE = 'RLAM_COMP_RAT'
          AND RatingFactor.TARGET_ENUMERATION_TYPE = 'MERCER_RATING_FACTOR'
  )

  SELECT 
      POS.SECURITY_ID,
      POS.ALADDIN_SECURITY_CUSIP,
      POS.POSITION_DATE,
      SecRating.CLASSIFICATION_SCHEME_CODE,
      SecRating.CLASSIFICATION_DATE,
      SecRating.LEVEL_01_NAME,
      SecRating.TARGET_ENUMERATION_VALUE
  FROM POS
  INNER JOIN SecRating 
      ON SecRating.ALADDIN_SECURITY_CUSIP = POS.ALADDIN_SECURITY_CUSIP
      
  WHERE SecRating.CLASSIFICATION_DATE = (
          SELECT MAX(CLASSIFICATION_DATE) 
          FROM SE_DEMO_LIBRARY.RLAM_POV.V_BL_SECURITY_CLASSIFICATION_HIST
          WHERE CLASSIFICATION_SCHEME_CODE = 'RLAM_COMP_RAT'
              AND ALADDIN_SECURITY_CUSIP = POS.ALADDIN_SECURITY_CUSIP
              AND CLASSIFICATION_DATE <= POSITION_DATE
      )
                                         

  GROUP BY
      POS.SECURITY_ID,
      POS.ALADDIN_SECURITY_CUSIP,
      POS.POSITION_DATE,
      SecRating.CLASSIFICATION_SCHEME_CODE,
      SecRating.CLASSIFICATION_DATE,
      SecRating.LEVEL_01_NAME,
      SecRating.TARGET_ENUMERATION_VALUE
      
  ORDER BY 
      POS.POSITION_DATE
