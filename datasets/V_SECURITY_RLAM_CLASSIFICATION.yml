unique_name: V_SECURITY_RLAM_CLASSIFICATION
object_type: dataset
label: V_SECURITY_RLAM_CLASSIFICATION
columns:
  - name: SECURITY_ID
    data_type: string
  - name: SECURITY_SOURCE
    data_type: string
  - name: RLAM_CLASSIFICATION_L5_CODE
    data_type: decimal(38,0)
  - name: RLAM_CLASSIFICATION_L1_NAME
    data_type: string
  - name: RLAM_SECTOR
    data_type: string
  - name: LOCAL_CURRENCY
    data_type: string
connection_id: con_SE_DEMO_LIBRARY_RLAM_POV
sql: >
  WITH POS AS
  (
  SELECT
  SECURITY_ID,
  LOCAL_CURRENCY

  FROM SE_DEMO_LIBRARY.RLAM_POV.SECURITY_POSITION
  GROUP BY SECURITY_ID, LOCAL_CURRENCY
  ),


  CLASS AS

  (
  SELECT
  SECURITY_ID,
  RLAM_CLASSIFICATION_L1_NAME, 
  RLAM_CLASSIFICATION_L5_CODE,
  SECURITY_SOURCE,
  CASE WHEN COALESCE(RLAM_CLASSIFICATION_L1_NAME,'UNKNOWN') NOT IN ('Cash', 'Currency') THEN IFNULL(RLAM_SECTOR, 'UNCLASSIFIED') ELSE 'Cash' END AS RLAM_SECTOR,

  FROM SE_DEMO_LIBRARY.RLAM_POV.V_SECURITY_RLAM_CLASSIFICATION

  WHERE ( SECURITY_SOURCE = 'HSBC' OR SECURITY_SOURCE = 'STATESTREET' )
  GROUP BY SECURITY_ID, RLAM_CLASSIFICATION_L1_NAME, RLAM_CLASSIFICATION_L5_CODE, SECURITY_SOURCE, RLAM_SECTOR
  )


  SELECT
  POS.SECURITY_ID,
  RLAM_CLASSIFICATION_L1_NAME, 
  RLAM_CLASSIFICATION_L5_CODE,
  SECURITY_SOURCE,
  RLAM_SECTOR,
  CASE WHEN COALESCE(RLAM_CLASSIFICATION_L1_NAME,'UNKNOWN') NOT IN ('Cash', 'Currency') THEN POS.LOCAL_CURRENCY ELSE 'Cash' END AS LOCAL_CURRENCY
            
  FROM POS

  LEFT JOIN CLASS
  ON POS.SECURITY_ID = CLASS.SECURITY_ID
